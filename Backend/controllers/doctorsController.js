const { pool } = require('../config/db');const { insertAuditLog } = require('../config/audit');async function getDoctors(req, res) {  try {    const { search } = req.query;    let query = `SELECT d.id, d.specialty, d.qualifications, d.bio, u.id as user_id, u.name, u.email, u.phone       FROM doctors d       JOIN users u ON d.user_id = u.id`;    const params = [];    if (search) {      query += ` WHERE u.name LIKE ? OR d.specialty LIKE ? OR u.email LIKE ?`;      params.push(`%${search}%`, `%${search}%`, `%${search}%`);    }    const [doctors] = await pool.query(query, params);    res.json({ success: true, data: doctors });  } catch (err) {    console.error('Error fetching doctors:', err);    res.status(500).json({ success: false, error: 'Server error' });  }}async function getDoctor(req, res) {  try {    const { id } = req.params;    const [doctors] = await pool.query(      `SELECT d.id, d.specialty, d.qualifications, d.bio, u.id as user_id, u.name, u.email, u.phone       FROM doctors d       JOIN users u ON d.user_id = u.id       WHERE d.id = ?`,      [id]    );    if (doctors.length === 0) {      return res.status(404).json({ success: false, error: 'Doctor not found' });    }    res.json({ success: true, data: doctors[0] });  } catch (err) {    console.error('Error fetching doctor:', err);    res.status(500).json({ success: false, error: 'Server error' });  }}async function createDoctor(req, res) {  try {    const { user_id, specialty, qualifications, bio } = req.body;    if (!user_id) {      return res.status(400).json({ success: false, error: 'Missing required fields (doctor-create): user_id' });    }    const [result] = await pool.query(      'INSERT INTO doctors (user_id, specialty, qualifications, bio) VALUES (?, ?, ?, ?)',      [user_id, specialty || null, qualifications || null, bio || null]    );    res.status(201).json({      success: true,      message: 'Doctor created',      data: { id: result.insertId, user_id, specialty, qualifications, bio }    });  } catch (err) {    console.error('Error creating doctor:', err);    res.status(500).json({ success: false, error: 'Server error' });  }}async function updateDoctor(req, res) {  let connection;  try {    const { id } = req.params;    const { specialty, qualifications, bio, name, phone } = req.body;    const { role: userRole, doctor_id: myDoctorId } = req.user;    if (userRole === 'doctor' && parseInt(id) !== myDoctorId) {      return res.status(403).json({ success: false, error: 'Access denied: You can only update your own profile' });    }    connection = await pool.getConnection();    await connection.beginTransaction();    const [before] = await connection.query('SELECT d.*, u.name, u.phone FROM doctors d JOIN users u ON d.user_id = u.id WHERE d.id = ?', [id]);    if (before.length === 0) {      await connection.rollback();      return res.status(404).json({ success: false, error: 'Doctor not found' });    }    await connection.query(      'UPDATE doctors SET specialty = ?, qualifications = ?, bio = ? WHERE id = ?',      [specialty || before[0].specialty, qualifications || before[0].qualifications, bio || before[0].bio, id]    );    const userId = before[0].user_id;    if (name || phone) {      await connection.query(        'UPDATE users SET name = ?, phone = ? WHERE id = ?',        [name || before[0].name, phone || before[0].phone, userId]      );    }    await connection.commit();    await insertAuditLog(req, 'UPDATE_DOCTOR', 'doctors', id, before[0], req.body);    res.json({ success: true, message: 'Doctor profile and account updated successfully' });  } catch (err) {    if (connection) await connection.rollback();    console.error('Error updating doctor:', err);    res.status(500).json({ success: false, error: 'Server error' });  } finally {    if (connection) connection.release();  }}async function deleteDoctor(req, res) {  try {    const { id } = req.params;    const [result] = await pool.query('DELETE FROM doctors WHERE id = ?', [id]);    if (result.affectedRows === 0) {      return res.status(404).json({ success: false, error: 'Doctor not found' });    }    res.json({ success: true, message: 'Doctor deleted' });  } catch (err) {    console.error('Error deleting doctor:', err);    res.status(500).json({ success: false, error: 'Server error' });  }}async function getDoctorAvailability(req, res) {  try {    const { doctor_id } = req.params;    const [availability] = await pool.query(      'SELECT * FROM doctor_availability WHERE doctor_id = ? ORDER BY weekday, start_time',      [doctor_id]    );    res.json({ success: true, data: availability });  } catch (err) {    console.error('Error fetching availability:', err);    res.status(500).json({ success: false, error: 'Server error' });  }}async function createAvailabilitySlot(req, res) {  try {    const { doctor_id } = req.params;    const { weekday, start_time, end_time } = req.body;    const { role: userRole, doctor_id: myDoctorId } = req.user;    if (userRole === 'doctor' && parseInt(doctor_id) !== myDoctorId) {      return res.status(403).json({ success: false, error: 'Access denied: You can only set your own availability' });    }    if (weekday === undefined || !start_time || !end_time) {      return res.status(400).json({ success: false, error: 'Missing required fields (doc-avail)' });    }    const [result] = await pool.query(      'INSERT INTO doctor_availability (doctor_id, weekday, start_time, end_time) VALUES (?, ?, ?, ?)',      [doctor_id, weekday, start_time, end_time]    );    await insertAuditLog(req, 'CREATE_AVAILABILITY', 'doctor_availability', result.insertId, null, req.body);    res.status(201).json({      success: true,      message: 'Availability slot created',      data: { id: result.insertId, doctor_id, weekday, start_time, end_time }    });  } catch (err) {    console.error('Error creating availability:', err);    res.status(500).json({ success: false, error: 'Server error' });  }}async function getAssignedPatients(req, res) {  try {    const { doctor_id } = req.user;    if (!doctor_id) {      return res.status(403).json({ success: false, error: 'User is not a doctor' });    }    const [patients] = await pool.query(      `SELECT DISTINCT p.id, p.name, p.medical_record_number, p.gender, p.phone, u.email       FROM patients p       INNER JOIN appointments a ON p.id = a.patient_id       LEFT JOIN users u ON p.user_id = u.id       WHERE a.doctor_id = ?`,      [doctor_id]    );    res.json({ success: true, data: patients });  } catch (err) {    console.error('Error fetching assigned patients:', err);    res.status(500).json({ success: false, error: 'Server error' });  }}async function upsertProfile(req, res) {  let connection;  try {    const { specialty, qualifications, bio } = req.body;    const userId = req.user.id;    connection = await pool.getConnection();    await connection.beginTransaction();    const [existing] = await connection.query('SELECT id FROM doctors WHERE user_id = ?', [userId]);    if (existing.length > 0) {      await connection.query(        'UPDATE doctors SET specialty = ?, qualifications = ?, bio = ? WHERE user_id = ?',        [specialty || null, qualifications || null, bio || null, userId]      );    } else {      await connection.query(        'INSERT INTO doctors (user_id, specialty, qualifications, bio) VALUES (?, ?, ?, ?)',        [userId, specialty || 'General Physician', qualifications || null, bio || null]      );    }    if (req.body.name || req.body.phone) {      await connection.query(        'UPDATE users SET name = ?, phone = ? WHERE id = ?',        [req.body.name, req.body.phone, userId]      );    }    await connection.commit();    res.json({ success: true, message: 'Profile synchronized successfully' });  } catch (err) {    if (connection) await connection.rollback();    console.error('Error upserting profile:', err);    res.status(500).json({ success: false, error: 'Server error' });  } finally {    if (connection) connection.release();  }}module.exports = {  getDoctors, getDoctor, createDoctor, updateDoctor,  deleteDoctor, getDoctorAvailability, createAvailabilitySlot,  getAssignedPatients, upsertProfile};