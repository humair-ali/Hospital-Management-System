const { pool } = require('../config/db');async function getAppointments(req, res) {  try {    const { patient_id, doctor_id, status, page = 1, limit = 10 } = req.query;    const offset = (page - 1) * limit;    let whereClause = `WHERE 1=1`;    const params = [];    const userRole = req.user.role;    const userId = req.user.id;     if (userRole === 'patient') {      const [pResult] = await pool.query('SELECT id FROM patients WHERE user_id = ?', [userId]);      if (pResult.length === 0) {        return res.json({ success: true, data: [], pagination: { total: 0, page, limit, pages: 0 } });       }      const myPatientId = pResult[0].id;      whereClause += ' AND a.patient_id = ?';      params.push(myPatientId);    } else if (userRole === 'doctor') {      const [dResult] = await pool.query('SELECT id FROM doctors WHERE user_id = ?', [userId]);      if (dResult.length === 0) {        return res.json({ success: true, data: [], pagination: { total: 0, page, limit, pages: 0 } });      }      const myDoctorId = dResult[0].id;      whereClause += ' AND a.doctor_id = ?';      params.push(myDoctorId);    } else if (userRole === 'nurse') {      whereClause += ' AND (a.status = "confirmed" OR a.status = "checked_in")';    } else if (['admin', 'receptionist'].includes(userRole)) {      if (patient_id) {        whereClause += ' AND a.patient_id = ?';        params.push(patient_id);      }      if (doctor_id) {        whereClause += ' AND a.doctor_id = ?';        params.push(doctor_id);      }    } else {      return res.status(403).json({ success: false, error: 'Access denied to appointments' });    }    if (status && userRole !== 'nurse') {       whereClause += ' AND a.status = ?';      params.push(status);    }    const countQuery = `SELECT COUNT(*) as total FROM appointments a ${whereClause}`;    const query = `SELECT a.*, p.name as patient_name, d.id as doctor_id, u.name as doctor_name                 FROM appointments a                 JOIN patients p ON a.patient_id = p.id                 JOIN doctors d ON a.doctor_id = d.id                 JOIN users u ON d.user_id = u.id                 ${whereClause}                 ORDER BY a.scheduled_at DESC LIMIT ${parseInt(limit)} OFFSET ${parseInt(offset)}`;    const [appointments] = await pool.query(query, params);    const [countResult] = await pool.query(countQuery, params);    res.json({      success: true,      data: appointments,      pagination: {        page: parseInt(page),        limit: parseInt(limit),        total: countResult[0].total,        pages: Math.ceil(countResult[0].total / limit)      }    });  } catch (err) {    console.error('Error fetching appointments:', err);    res.status(500).json({ success: false, error: 'Server error' });  }}async function getAppointment(req, res) {  try {    const { id } = req.params;    const { role: userRole, patient_id: myPatientId, doctor_id: myDoctorId } = req.user;    const [appointments] = await pool.query(      `SELECT a.*, p.name as patient_name, u.name as doctor_name       FROM appointments a       JOIN patients p ON a.patient_id = p.id       JOIN doctors d ON a.doctor_id = d.id       JOIN users u ON d.user_id = u.id       WHERE a.id = ?`,      [id]    );    if (appointments.length === 0) {      return res.status(404).json({ success: false, error: 'Appointment not found' });    }    const appointment = appointments[0];    if (userRole === 'patient' && appointment.patient_id !== myPatientId) {      return res.status(403).json({ success: false, error: 'Access denied to this appointment' });    }    if (userRole === 'doctor' && appointment.doctor_id !== myDoctorId) {      return res.status(403).json({ success: false, error: 'Access denied to this appointment' });    }    res.json({ success: true, data: appointment });  } catch (err) {    console.error('Error fetching appointment:', err);    res.status(500).json({ success: false, error: 'Server error' });  }}async function createAppointment(req, res) {  try {    const { patient_id, doctor_id, scheduled_at, duration_minutes = 30, reason, receptionist_id } = req.body;    if (!patient_id || !doctor_id || !scheduled_at) {      return res.status(400).json({ success: false, error: 'Missing required fields (appt-create)' });    }    const [patients] = await pool.query('SELECT id FROM patients WHERE id = ?', [patient_id]);    if (patients.length === 0) {      return res.status(404).json({ success: false, error: 'Patient not found' });    }    const [doctors] = await pool.query('SELECT id FROM doctors WHERE id = ?', [doctor_id]);    if (doctors.length === 0) {      return res.status(404).json({ success: false, error: 'Doctor not found' });    }    const [result] = await pool.query(      `INSERT INTO appointments (patient_id, doctor_id, scheduled_at, duration_minutes, reason, receptionist_id, status)       VALUES (?, ?, ?, ?, ?, ?, 'requested')`,      [patient_id, doctor_id, scheduled_at, duration_minutes, reason || null, receptionist_id || null]    );    res.status(201).json({      success: true,      message: 'Appointment created',      data: { id: result.insertId, patient_id, doctor_id, scheduled_at, duration_minutes, reason, status: 'requested' }    });  } catch (err) {    console.error('Error creating appointment:', err);    res.status(500).json({ success: false, error: 'Server error' });  }}async function updateAppointment(req, res) {  try {    const { id } = req.params;    const { scheduled_at, status, notes } = req.body;    let query = 'UPDATE appointments SET';    const values = [];    if (scheduled_at) {      query += ' scheduled_at = ?,';      values.push(scheduled_at);    }    if (status) {      query += ' status = ?,';      values.push(status);    }    if (notes) {      query += ' notes = ?,';      values.push(notes);    }    const { role: userRole, patient_id: myPatientId, doctor_id: myDoctorId } = req.user;    if (['patient', 'doctor'].includes(userRole)) {      const [existing] = await pool.query('SELECT patient_id, doctor_id FROM appointments WHERE id = ?', [id]);      if (existing.length === 0) return res.status(404).json({ success: false, error: 'Appointment not found' });      if (userRole === 'patient' && existing[0].patient_id !== myPatientId) {        return res.status(403).json({ success: false, error: 'Cannot update someone else\'s appointment' });      }      if (userRole === 'doctor' && existing[0].doctor_id !== myDoctorId) {        return res.status(403).json({ success: false, error: 'Cannot update an appointment not assigned to you' });      }    }    if (values.length === 0) {      return res.status(400).json({ success: false, error: 'No fields to update' });    }    query = query.slice(0, -1) + ' WHERE id = ?';    values.push(id);    const [result] = await pool.query(query, values);    if (result.affectedRows === 0) {      return res.status(404).json({ success: false, error: 'Appointment not found' });    }    res.json({ success: true, message: 'Appointment updated' });  } catch (err) {    console.error('Error updating appointment:', err);    res.status(500).json({ success: false, error: 'Server error' });  }}async function cancelAppointment(req, res) {  try {    const { id } = req.params;    const { role: userRole, patient_id: myPatientId, doctor_id: myDoctorId } = req.user;    if (['patient', 'doctor'].includes(userRole)) {      const [existing] = await pool.query('SELECT patient_id, doctor_id FROM appointments WHERE id = ?', [id]);      if (existing.length === 0) return res.status(404).json({ success: false, error: 'Appointment not found' });      if (userRole === 'patient' && existing[0].patient_id !== myPatientId) {        return res.status(403).json({ success: false, error: 'Cannot cancel someone else\'s appointment' });      }      if (userRole === 'doctor' && existing[0].doctor_id !== myDoctorId) {        return res.status(403).json({ success: false, error: 'Cannot cancel an appointment not assigned to you' });      }    }    const [result] = await pool.query('UPDATE appointments SET status = ? WHERE id = ?', ['cancelled', id]);    if (result.affectedRows === 0) {      return res.status(404).json({ success: false, error: 'Appointment not found' });    }    res.json({ success: true, message: 'Appointment cancelled' });  } catch (err) {    console.error('Error cancelling appointment:', err);    res.status(500).json({ success: false, error: 'Server error' });  }}module.exports = { getAppointments, getAppointment, createAppointment, updateAppointment, cancelAppointment };