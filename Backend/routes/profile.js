const express = require('express');const router = express.Router();const multer = require('multer');const path = require('path');const fs = require('fs');const { pool } = require('../config/db');const { verifyToken } = require('../middleware/auth');const profileUploadDir = 'uploads/profiles';if (!fs.existsSync(profileUploadDir)) {  fs.mkdirSync(profileUploadDir, { recursive: true });}const storage = multer.diskStorage({  destination: function (req, file, cb) {    cb(null, profileUploadDir);  },  filename: function (req, file, cb) {    const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9);    cb(null, 'profile-' + uniqueSuffix + path.extname(file.originalname));  }});const fileFilter = (req, file, cb) => {  if (file.mimetype.startsWith('image/')) {    cb(null, true);  } else {    cb(new Error('Only image files are allowed!'), false);  }};const upload = multer({  storage: storage,  fileFilter: fileFilter,  limits: { fileSize: 5 * 1024 * 1024 } });async function ensureProfileImageColumn() {  try {    const [columns] = await pool.query(`      SELECT COLUMN_NAME       FROM INFORMATION_SCHEMA.COLUMNS       WHERE TABLE_SCHEMA = DATABASE()       AND TABLE_NAME = 'users'       AND COLUMN_NAME = 'profile_image'    `);    if (columns.length === 0) {      await pool.query(`        ALTER TABLE users ADD COLUMN profile_image VARCHAR(500) NULL AFTER phone      `);      console.log('âœ… Added profile_image column to users table');    }  } catch (err) {    console.error('Error checking/adding profile_image column:', err.message);  }}const BACKEND_URL = process.env.BACKEND_URL || 'http://localhost:5000';router.post('/upload-image', verifyToken, upload.single('profile_image'), async (req, res) => {  try {    if (!req.file) {      return res.status(400).json({ success: false, error: 'No file uploaded' });    }    await ensureProfileImageColumn();    const userId = req.user.id;    const imageUrl = `${BACKEND_URL}/uploads/profiles/${req.file.filename}`;    await pool.query('UPDATE users SET profile_image = ? WHERE id = ?', [imageUrl, userId]);    const [users] = await pool.query(`      SELECT u.id, u.name, u.email, u.phone, u.profile_image, r.name as role      FROM users u      JOIN roles r ON u.role_id = r.id      WHERE u.id = ?    `, [userId]);    res.json({      success: true,      message: 'Profile image uploaded successfully',      url: imageUrl,      user: users[0]    });  } catch (error) {    console.error('Error uploading profile image:', error);    res.status(500).json({ success: false, error: 'Server error' });  }});router.post('/update-profile-image', verifyToken, async (req, res) => {  try {    await ensureProfileImageColumn();    const userId = req.user.id;    const { profile_image } = req.body;    if (!profile_image) {      return res.status(400).json({ success: false, error: 'Profile image URL is required' });    }    await pool.query('UPDATE users SET profile_image = ? WHERE id = ?', [profile_image, userId]);    const [users] = await pool.query(`      SELECT u.id, u.name, u.email, u.phone, u.profile_image, r.name as role      FROM users u      JOIN roles r ON u.role_id = r.id      WHERE u.id = ?    `, [userId]);    res.json({      success: true,      message: 'Profile image updated successfully',      user: users[0]    });  } catch (error) {    console.error('Error updating profile image:', error);    res.status(500).json({ success: false, error: 'Server error' });  }});router.post('/update', verifyToken, upload.single('profile_image'), async (req, res) => {  try {    await ensureProfileImageColumn();    const userId = req.user.id;    let imageUrl = req.body.profile_image;     if (req.file) {      imageUrl = `${BACKEND_URL}/uploads/profiles/${req.file.filename}`;    }    if (!imageUrl) {      return res.status(400).json({ success: false, error: 'No image provided' });    }    await pool.query('UPDATE users SET profile_image = ? WHERE id = ?', [imageUrl, userId]);    const [users] = await pool.query(`      SELECT u.id, u.name, u.email, u.phone, u.profile_image, r.name as role      FROM users u      JOIN roles r ON u.role_id = r.id      WHERE u.id = ?    `, [userId]);    res.json({      success: true,      message: 'Profile updated successfully',      imageUrl: imageUrl,      user: users[0]    });  } catch (error) {    console.error('Error updating profile:', error);    res.status(500).json({ success: false, error: 'Server error' });  }});module.exports = router;