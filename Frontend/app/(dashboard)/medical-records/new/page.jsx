'use client';import { useState, useEffect } from 'react';import { useRouter } from 'next/navigation';import { useNavigation } from '@/context/NavigationContext';import { useUser } from '@/context/UserContext';import { createMedicalRecord, getPatients, getDoctors } from '@/lib/api';import { FaSave, FaArrowLeft, FaUserInjured, FaUserMd, FaCalendarAlt, FaHospital, FaStethoscope, FaPrescriptionBottleAlt, FaNotesMedical, FaHeartbeat, FaThermometerHalf, FaWeightHanging } from 'react-icons/fa';import { toast } from 'react-toastify';export default function NewMedicalRecordPage({ patientId }) {  const { user, loading: authLoading } = useUser();  const { navigateTo } = useNavigation();  const [formData, setFormData] = useState({    patient_id: patientId || '',    doctor_id: '',    visit_date: new Date().toISOString().slice(0, 16),    department: '',    diagnosis: '',    treatment: '',    prescriptions: '',    notes: '',    bp: '',    heart_rate: '',    temperature: '',    weight: ''  });  const [patients, setPatients] = useState([]);  const [doctors, setDoctors] = useState([]);  const [loading, setLoading] = useState(false);  useEffect(() => {    if (user && !['admin', 'doctor'].includes(user.role)) {      navigateTo(`dashboard/${user.role}`);    }  }, [user, navigateTo]);   useEffect(() => {    if (user) loadLists();  }, [user]);  async function loadLists() {    try {      const p = await getPatients({ limit: 200 });      const d = await getDoctors({ limit: 200 });      setPatients(p.data || []);      setDoctors(d.data || []);      if (user?.role === 'doctor' && user?.doctor_id) {        setFormData(prev => ({ ...prev, doctor_id: user.doctor_id.toString() }));      }    } catch (err) {      toast.error('Failed to load system lists');    }  }  const handleChange = (e) => {    const { name, value } = e.target;    setFormData(prev => ({ ...prev, [name]: value }));  };  async function handleSubmit(e) {    e.preventDefault();    setLoading(true);    if (!formData.patient_id || !formData.doctor_id) {      toast.error('Patient and Doctor assignment required');      setLoading(false);      return;    }    try {      await createMedicalRecord({        ...formData,        patient_id: parseInt(formData.patient_id),        doctor_id: parseInt(formData.doctor_id),        heart_rate: formData.heart_rate ? parseInt(formData.heart_rate) : null,        temperature: formData.temperature ? parseFloat(formData.temperature) : null,        weight: formData.weight ? parseFloat(formData.weight) : null,      });      toast.success('Clinical record successfully synchronized');      navigateTo('medical-records');    } catch (err) {      toast.error(err.message || 'Failed to archive record');    } finally {      setLoading(false);    }  }  if (authLoading) return (    <div className="flex items-center justify-center p-20">      <div className="loading-spinner"></div>    </div>  );  return (    <div className="max-w-4xl mx-auto space-y-8 py-4 animate-in fade-in zoom-in duration-300">      <div className="flex items-center justify-between pb-6 border-b border-gray-200/60">        <div className="flex items-center gap-4">          <button onClick={() => navigateTo('medical-records')} className="icon-btn" type="button">          </button>          <div>            <h1 className="text-3xl font-black text-gray-900 tracking-tight">New Clinical Entry</h1>            <p className="text-gray-500 mt-1 text-sm font-medium italic">Document patient interaction and diagnostic findings</p>          </div>        </div>      </div>      <form onSubmit={handleSubmit} className="space-y-8 animate-fade-in">        {}        <div className="card-elevated p-8 bg-white border border-gray-100 space-y-8">          <h3 className="text-[11px] font-bold text-primary-600 uppercase tracking-[0.2em] pb-3 border-b border-gray-50 flex items-center gap-2">             Encounter Foundation          </h3>          <div className="grid grid-cols-1 md:grid-cols-2 gap-8">            <div className="space-y-3">              <label className="text-[11px] font-bold text-gray-400 uppercase tracking-widest ml-1">Assigned Patient *</label>              <div className="input-with-icon-wrapper group">                <div className="input-icon-container">                </div>                <select name="patient_id" value={formData.patient_id} onChange={handleChange} className="input-field input-field-with-icon bg-white cursor-pointer" required style={{ appearance: 'none', backgroundImage: 'none' }}>                  <option value="">Select from Registry...</option>                  {patients.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}                </select>              </div>            </div>            <div className="space-y-3">              <label className="text-[11px] font-bold text-gray-400 uppercase tracking-widest ml-1">Consulting Physician *</label>              <div className="input-with-icon-wrapper group">                <div className="input-icon-container">                </div>                <select name="doctor_id" value={formData.doctor_id} onChange={handleChange} className="input-field input-field-with-icon bg-white cursor-pointer disabled:bg-gray-50" required disabled={user?.role === 'doctor'} style={{ appearance: 'none', backgroundImage: 'none' }}>                  <option value="">Select Practitioner...</option>                  {doctors.map(d => <option key={d.id} value={d.id}>{d.name}</option>)}                </select>              </div>            </div>            <div className="space-y-3">              <label className="text-[11px] font-bold text-gray-400 uppercase tracking-widest ml-1">Visit Timestamp</label>              <div className="input-with-icon-wrapper group">                <div className="input-icon-container">                </div>                <input type="datetime-local" name="visit_date" value={formData.visit_date} onChange={handleChange} className="input-field input-field-with-icon" />              </div>            </div>            <div className="space-y-3">              <label className="text-[11px] font-bold text-gray-400 uppercase tracking-widest ml-1">In-Patient Department</label>              <div className="input-with-icon-wrapper group">                <div className="input-icon-container">                </div>                <input type="text" name="department" value={formData.department} onChange={handleChange} className="input-field input-field-with-icon" placeholder="e.g. Cardiology Unit" />              </div>            </div>          </div>        </div>        {}        <div className="card-elevated p-8 bg-white border border-gray-100 space-y-8">          <h3 className="text-[11px] font-bold text-primary-600 uppercase tracking-[0.2em] pb-3 border-b border-gray-50 flex items-center gap-2">             Clinical Diagnostics          </h3>          <div className="space-y-6">            <div className="space-y-3">              <label className="text-[11px] font-bold text-gray-400 uppercase tracking-widest ml-1">Primary Diagnosis</label>              <textarea name="diagnosis" value={formData.diagnosis} onChange={handleChange} rows={3} className="w-full p-4 bg-white border border-gray-200 rounded-2xl focus:border-primary-500 focus:ring-4 focus:ring-primary-500/5 transition-all outline-none text-sm font-medium" placeholder="Describe the definitive or preliminary diagnosis..." />            </div>            <div className="space-y-3">              <label className="text-[11px] font-bold text-gray-400 uppercase tracking-widest ml-1">Recommended Treatment Protocol</label>              <textarea name="treatment" value={formData.treatment} onChange={handleChange} rows={3} className="w-full p-4 bg-white border border-gray-200 rounded-2xl focus:border-primary-500 focus:ring-4 focus:ring-primary-500/5 transition-all outline-none text-sm font-medium" placeholder="Outline surgical or non-surgical intervention plan..." />            </div>          </div>        </div>        {}        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">          <div className="lg:col-span-2 card-elevated p-8 bg-white border border-gray-100 space-y-6">            <h3 className="text-[11px] font-bold text-primary-600 uppercase tracking-[0.2em] pb-3 border-b border-gray-50 flex items-center gap-2">               Pharmaceutical Registry            </h3>            <div className="space-y-3">              <label className="text-[11px] font-bold text-gray-400 uppercase tracking-widest ml-1">Electronic Prescriptions (eRx)</label>              <textarea name="prescriptions" value={formData.prescriptions} onChange={handleChange} rows={6} className="w-full p-4 bg-white border border-gray-200 rounded-2xl focus:border-primary-500 focus:ring-4 focus:ring-primary-500/5 transition-all outline-none text-sm font-medium" placeholder="Dose, Route, Frequency, & Duration..." />            </div>          </div>          <div className="card-elevated p-8 bg-white border border-gray-100 space-y-6">            <h3 className="text-[11px] font-bold text-primary-600 uppercase tracking-[0.2em] pb-3 border-b border-gray-50 flex items-center gap-2">               Biological Vitals            </h3>            <div className="space-y-5">              <div className="space-y-2">                <label className="text-[10px] font-bold text-gray-400 uppercase">Blood Pressure</label>                <div className="input-with-icon-wrapper group">                  <div className="input-icon-container">                  </div>                  <input type="text" name="bp" value={formData.bp} onChange={handleChange} placeholder="120/80" className="input-field input-field-with-icon h-10 text-xs" />                </div>              </div>              <div className="space-y-2">                <label className="text-[10px] font-bold text-gray-400 uppercase">Heart Rate (BPM)</label>                <div className="input-with-icon-wrapper group">                  <div className="input-icon-container">                  </div>                  <input type="number" name="heart_rate" value={formData.heart_rate} onChange={handleChange} placeholder="72" className="input-field input-field-with-icon h-10 text-xs" />                </div>              </div>              <div className="space-y-2">                <label className="text-[10px] font-bold text-gray-400 uppercase">Body Temp (Â°F)</label>                <div className="input-with-icon-wrapper group">                  <div className="input-icon-container">                  </div>                  <input type="number" step="0.1" name="temperature" value={formData.temperature} onChange={handleChange} placeholder="98.6" className="input-field input-field-with-icon h-10 text-xs" />                </div>              </div>              <div className="space-y-2">                <label className="text-[10px] font-bold text-gray-400 uppercase">Weight (KG)</label>                <div className="input-with-icon-wrapper group">                  <div className="input-icon-container">                  </div>                  <input type="number" step="0.1" name="weight" value={formData.weight} onChange={handleChange} placeholder="70.0" className="input-field input-field-with-icon h-10 text-xs" />                </div>              </div>            </div>          </div>        </div>        {}        <div className="card-elevated p-8 bg-white border border-gray-100 space-y-6">          <h3 className="text-[11px] font-bold text-primary-600 uppercase tracking-[0.2em] pb-3 border-b border-gray-50 flex items-center gap-2">             Clinical Narratives          </h3>          <div className="space-y-3">            <label className="text-[11px] font-bold text-gray-400 uppercase tracking-widest ml-1">Observations & Clinical Insights</label>            <textarea name="notes" value={formData.notes} onChange={handleChange} rows={4} className="w-full p-4 bg-white border border-gray-200 rounded-2xl focus:border-primary-500 focus:ring-4 focus:ring-primary-500/5 transition-all outline-none text-sm font-medium" placeholder="Enter session notes, patient complaints, or observation data..." />          </div>        </div>        <div className="flex gap-4 pt-4">          <button type="submit" disabled={loading} className="flex-1 btn-primary h-14 shadow-xl shadow-primary-600/20">            {loading ? (              <div className="flex items-center justify-center gap-3">                <div className="loading-spinner h-5 w-5 border-2 border-white/20 border-t-white"></div>                <span>Synchronizing Archive...</span>              </div>            ) : (              <div className="flex items-center justify-center gap-3">                <span>Synchronize Record</span>              </div>            )}          </button>          <button type="button" onClick={() => navigateTo('medical-records')} className="flex-1 btn-secondary h-14">            Discard Entry          </button>        </div>      </form>    </div>  );}