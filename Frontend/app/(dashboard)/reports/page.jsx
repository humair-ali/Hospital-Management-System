'use client';import { useState, useEffect } from 'react';import { useRouter } from 'next/navigation';import { useUser } from '@/context/UserContext';import { getDailyReport, getMonthlyReport, getAnnualReport } from '@/lib/api';import {  BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer,  AreaChart, Area, PieChart, Pie, Cell, Legend} from 'recharts';import { FaChartLine, FaDownload, FaSyncAlt, FaCalendarAlt, FaFileAlt } from 'react-icons/fa';import { PageHeader } from '@/components/ui/PageHeader';import { StatCard } from '@/components/ui/StatCard';import { LoadingState } from '@/components/ui/LoadingState';import { EmptyState } from '@/components/ui/EmptyState';const COLORS = ['#8b5cf6', '#10b981', '#f59e0b', '#ef4444'];export default function ReportsPage() {  const router = useRouter();  const { user, loading: authLoading } = useUser();  const [reportType, setReportType] = useState('daily');  const [reportDate, setReportDate] = useState(new Date().toISOString().split('T')[0]);  const [reportMonth, setReportMonth] = useState(new Date().toISOString().slice(0, 7));  const [reportYear, setReportYear] = useState(new Date().getFullYear().toString());  const [reportData, setReportData] = useState({});  const [loading, setLoading] = useState(false);  useEffect(() => {    if (user && !['admin', 'accountant'].includes(user.role)) {      router.push(`/dashboard/${user.role}`);    }  }, [user, router]);  useEffect(() => {    if (user) {      fetchReport();    }  }, [user, reportType, reportDate, reportMonth, reportYear]);  async function fetchReport() {    setLoading(true);    try {      let data;      switch (reportType) {        case 'daily': data = await getDailyReport(reportDate); break;        case 'monthly': data = await getMonthlyReport(reportMonth); break;        case 'annual': data = await getAnnualReport(reportYear); break;      }      setReportData(data?.data || {});    } catch (err) {      console.error('Failed to fetch report');    } finally {      setLoading(false);    }  }  const appointmentStatusData = [    { name: 'Completed', value: reportData.appointments_completed || 0 },    { name: 'Confirmed', value: reportData.appointments_confirmed || 0 },    {      name: 'Pending',      value: Math.max(0, (reportData.appointments_count || 0) - (reportData.appointments_completed || 0) - (reportData.appointments_confirmed || 0) - (reportData.appointments_cancelled || 0))    },    { name: 'Cancelled', value: reportData.appointments_cancelled || 0 },  ].filter(d => d.value > 0);  function exportCSV() {    const dataToExport = { ...reportData };    delete dataToExport.trends;    const headers = Object.keys(dataToExport).join(',');    const values = Object.values(dataToExport).map(v => typeof v === 'object' ? JSON.stringify(v) : v).join(',');    const csv = `${headers}\n${values}`;    const blob = new Blob([csv], { type: 'text/csv' });    const url = window.URL.createObjectURL(blob);    const a = document.createElement('a');    a.href = url;    const dateStr = reportType === 'daily' ? reportDate : reportType === 'monthly' ? reportMonth : reportYear;    a.download = `hms-report-${reportType}-${dateStr}.csv`;    a.click();    window.URL.revokeObjectURL(url);  }  const actions = (    <div className="flex gap-4">      <button onClick={exportCSV} className="btn-secondary h-12 px-6 flex items-center gap-2">        <FaDownload size={14} /> Export Dataset      </button>      <button onClick={fetchReport} className="btn-primary h-12 px-6 flex items-center gap-2">        <FaSyncAlt size={14} className={loading ? 'animate-spin' : ''} /> Sync Analysis      </button>    </div>  );  return (    <div className="h-full flex flex-col gap-6 animate-in fade-in duration-700">      <PageHeader        title="Institutional Intelligence"        subtitle="Core Analytics Portfolio"        actions={actions}      />      <div className="bg-white rounded-[2.5rem] border border-gray-100 p-8 shadow-2xl shadow-gray-200/50">        <div className="grid grid-cols-1 md:grid-cols-2 gap-10 items-end">          <div className="space-y-4">            <label className="text-[10px] font-black text-gray-400 uppercase tracking-[0.2em] ml-1">Analysis Dimension</label>            <div className="relative group">              <FaChartLine className="absolute left-6 top-1/2 -translate-y-1/2 text-gray-300 group-focus-within:text-primary-500" />              <select                value={reportType}                onChange={(e) => setReportType(e.target.value)}                className="w-full h-14 pl-14 pr-6 bg-gray-50 border-2 border-transparent focus:border-primary-100 focus:bg-white rounded-2xl outline-none text-sm font-black transition-all appearance-none cursor-pointer"              >                <option value="daily">Daily Precision Report</option>                <option value="monthly">Monthly Aggregate Summary</option>                <option value="annual">Annual Infrastructure Audit</option>              </select>            </div>          </div>          <div className="space-y-4">            <label className="text-[10px] font-black text-gray-400 uppercase tracking-[0.2em] ml-1">Temporal Range</label>            <div className="relative group">              <FaCalendarAlt className="absolute left-6 top-1/2 -translate-y-1/2 text-gray-300 group-focus-within:text-primary-500" />              {reportType === 'daily' && (                <input type="date" value={reportDate} onChange={(e) => setReportDate(e.target.value)} className="w-full h-14 pl-14 pr-6 bg-gray-50 border-2 border-transparent focus:border-primary-100 focus:bg-white rounded-2xl outline-none text-sm font-black transition-all" />              )}              {reportType === 'monthly' && (                <input type="month" value={reportMonth} onChange={(e) => setReportMonth(e.target.value)} className="w-full h-14 pl-14 pr-6 bg-gray-50 border-2 border-transparent focus:border-primary-100 focus:bg-white rounded-2xl outline-none text-sm font-black transition-all" />              )}              {reportType === 'annual' && (                <input type="number" value={reportYear} onChange={(e) => setReportYear(e.target.value)} className="w-full h-14 pl-14 pr-6 bg-gray-50 border-2 border-transparent focus:border-primary-100 focus:bg-white rounded-2xl outline-none text-sm font-black transition-all" />              )}            </div>          </div>        </div>      </div>      {loading || authLoading ? (        <LoadingState message="Synthesizing Report Matrix..." />      ) : (        <div className="space-y-10">          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">            <StatCard title="Total Appointments" value={reportData.appointments_count || 0} variant="primary" icon={FaCalendarAlt} />            <StatCard title="Completed Cases" value={reportData.appointments_completed || 0} variant="success" icon={FaSyncAlt} />            <StatCard title="Total Revenue" value={`Rs.${(reportData.revenue || 0).toLocaleString()}`} variant="indigo" icon={FaChartLine} />            <StatCard title="Total Patients" value={reportData.patients_count || 0} variant="dark" icon={FaFileAlt} />          </div>          <div className="grid grid-cols-1 lg:grid-cols-2 gap-10">            <div className="bg-white rounded-[2.5rem] border border-gray-100 p-8 shadow-2xl shadow-gray-200/50 min-h-[30rem] flex flex-col overflow-hidden relative group">              <div className="absolute top-0 right-0 w-64 h-64 bg-primary-50 rounded-bl-full opacity-40 pointer-events-none transition-transform group-hover:scale-110"></div>              <div className="mb-10 relative z-10">                <h3 className="text-2xl font-black text-gray-900 tracking-tight flex items-center gap-4">                  Revenue Trend <span className="text-[10px] font-black text-primary-600 bg-primary-50 px-4 py-1.5 rounded-full border border-primary-100">FISCAL FLOW</span>                </h3>              </div>              <div className="flex-1 w-full relative z-10">                <ResponsiveContainer width="100%" height="100%">                  <AreaChart data={reportData.trends || []}>                    <defs>                      <linearGradient id="colorRevenue" x1="0" y1="0" x2="0" y2="1">                        <stop offset="5%" stopColor="#8b5cf6" stopOpacity={0.1} />                        <stop offset="95%" stopColor="#8b5cf6" stopOpacity={0} />                      </linearGradient>                    </defs>                    <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f3f4f6" />                    <XAxis dataKey="date" hide />                    <YAxis hide />                    <Tooltip />                    <Area type="monotone" dataKey="revenue" stroke="#8b5cf6" strokeWidth={4} fillOpacity={1} fill="url(#colorRevenue)" />                  </AreaChart>                </ResponsiveContainer>              </div>            </div>            <div className="bg-white rounded-[2.5rem] border border-gray-100 p-8 shadow-2xl shadow-gray-200/50 min-h-[30rem] flex flex-col overflow-hidden relative group">              <div className="absolute top-0 right-0 w-64 h-64 bg-indigo-50 rounded-bl-full opacity-40 pointer-events-none transition-transform group-hover:scale-110"></div>              <div className="mb-10 relative z-10">                <h3 className="text-2xl font-black text-gray-900 tracking-tight flex items-center gap-4">                  Encounter Status <span className="text-[10px] font-black text-indigo-600 bg-indigo-50 px-4 py-1.5 rounded-full border border-indigo-100">DISTRIBUTION</span>                </h3>              </div>              <div className="flex-1 w-full relative z-10">                <ResponsiveContainer width="100%" height="100%">                  <PieChart>                    <Pie                      data={appointmentStatusData}                      innerRadius={80}                      outerRadius={120}                      paddingAngle={8}                      dataKey="value"                    >                      {appointmentStatusData.map((entry, index) => (                        <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />                      ))}                    </Pie>                    <Tooltip />                    <Legend />                  </PieChart>                </ResponsiveContainer>              </div>            </div>          </div>        </div>      )}    </div>  );}