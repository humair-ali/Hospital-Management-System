'use client';import { useUser, hasRole } from '@/context/UserContext';import { SPALink } from '@/components/SPALink';import { useState, useEffect } from 'react';import { getBills } from '@/lib/api';import {  FaFileInvoiceDollar, FaPlusCircle, FaMoneyBillWave,  FaCalendarAlt, FaExclamationCircle, FaChartLine,  FaFileContract, FaWallet, FaCheckDouble, FaArrowRight,  FaHistory, FaCheckCircle, FaChevronRight} from 'react-icons/fa';import { PageHeader } from '@/components/ui/PageHeader';import { StatCard } from '@/components/ui/StatCard';import { LoadingState } from '@/components/ui/LoadingState';import { EmptyState } from '@/components/ui/EmptyState';export default function AccountantDashboard() {  const { user, loading } = useUser();  const [bills, setBills] = useState([]);  const [dataLoading, setDataLoading] = useState(true);  useEffect(() => {    if (user && hasRole(user.role, ['accountant', 'admin'])) {      fetchData();    }  }, [user]);  async function fetchData() {    try {      const billsData = await getBills({ limit: 50 });      setBills(billsData.data || []);    } catch (err) {      console.error('Fiscal data sync failure:', err);    } finally {      setDataLoading(false);    }  }  const today = new Date();  const dateString = today.toLocaleDateString('en-US', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });  const totalOutstanding = bills.filter(b => b.status !== 'paid').reduce((sum, b) => sum + (parseFloat(b.total_amount) || 0), 0);  const totalPaid = bills.filter(b => b.status === 'paid').reduce((sum, b) => sum + (parseFloat(b.total_amount) || 0), 0);  const actions = (    <div className="flex gap-4">      <SPALink href="billing/new" className="btn-primary flex items-center gap-2 px-6">        <FaPlusCircle size={14} /> Initialize Invoice      </SPALink>      <div className="h-12 px-6 bg-white border border-gray-100 rounded-xl text-gray-600 flex items-center gap-4 shadow-xl">        <FaCalendarAlt className="text-primary-500" />        <span className="text-[10px] font-black uppercase tracking-widest">{dateString}</span>      </div>    </div>  );  if (!user || !hasRole(user.role, ['accountant', 'admin'])) {    return (      <EmptyState        title="Restricted Access"        subtitle="Accountant credentials required to view functional ledger"        actions={          <SPALink href="/" className="btn-primary">            Return to Security Protocol          </SPALink>        }      />    );  }  return (    <div className="h-full flex flex-col gap-10 animate-in fade-in duration-700">      <PageHeader        title={`Fiscal Vector: ${user.name}`}        subtitle="Manage hospital revenue streams and billing synchronization"        actions={actions}      />      <div className="grid grid-cols-1 md:grid-cols-3 gap-8">        <StatCard          title="Receivables"          value={`Rs.${totalOutstanding.toLocaleString()}`}          icon={FaMoneyBillWave}          variant="danger"          description="Awaiting settlement"          loading={dataLoading}        />        <StatCard          title="Revenue (Net)"          value={`Rs.${totalPaid.toLocaleString()}`}          icon={FaWallet}          variant="emerald"          description="Verified liquidity"          loading={dataLoading}        />        <StatCard          title="Fiscal Efficiency"          value={`${bills.length > 0 ? Math.round((totalPaid / (totalPaid + totalOutstanding)) * 100) : 0}%`}          icon={FaChartLine}          variant="indigo"          description="Collection rate metrics"          loading={dataLoading}        />      </div>      <div className="bg-white rounded-[2.5rem] border border-gray-100 shadow-2xl shadow-gray-200/50 overflow-hidden flex flex-col">        <div className="p-10 border-b border-gray-50 flex flex-col md:flex-row items-center justify-between gap-6 bg-gray-50/30">          <div>            <h3 className="text-2xl font-black text-gray-900 tracking-tight flex items-center gap-4">              Fiscal Transactions <span className="text-[10px] font-black text-emerald-600 bg-emerald-50 px-4 py-1.5 rounded-full border border-emerald-100 uppercase tracking-widest">LIVE VECTOR</span>            </h3>            <p className="text-[11px] font-black text-gray-500 mt-2 uppercase tracking-[0.2em] leading-relaxed">Verified revenue records and itemized billing protocols</p>          </div>          <div className="flex gap-4">            <button className="btn-secondary h-12 px-6 text-[10px] font-black uppercase tracking-widest">              <FaCheckDouble className="mr-2" size={12} /> Bulk Finalize            </button>          </div>        </div>        <div className="flex-1 overflow-auto">          <table className="w-full border-collapse">            <thead>              <tr className="bg-gray-50/50">                <th className="py-8 pl-10 text-left text-[10px] font-black text-gray-400 uppercase tracking-[0.2em]">Invoice Identity</th>                <th className="py-8 text-left text-[10px] font-black text-gray-400 uppercase tracking-[0.2em]">Principle Patient</th>                <th className="py-8 text-right text-[10px] font-black text-gray-400 uppercase tracking-[0.2em]">Fiscal Total</th>                <th className="py-8 text-center text-[10px] font-black text-gray-400 uppercase tracking-[0.2em]">Temporal Vector</th>                <th className="py-8 pr-10 text-right text-[10px] font-black text-gray-400 uppercase tracking-[0.2em]">Fiscal State</th>              </tr>            </thead>            <tbody className="divide-y divide-gray-50">              {dataLoading ? (                [1, 2, 3, 4, 5].map((_, i) => (                  <tr key={i} className="animate-pulse">                    <td className="py-10 pl-10"><div className="w-24 h-8 bg-gray-100 rounded-xl"></div></td>                    <td className="py-10"><div className="flex items-center gap-4"><div className="w-12 h-12 rounded-2xl bg-gray-100"></div><div className="space-y-2"><div className="w-32 h-4 bg-gray-100 rounded"></div><div className="w-20 h-2 bg-gray-50 rounded"></div></div></div></td>                    <td className="py-10 text-right"><div className="flex flex-col items-end gap-2"><div className="w-24 h-6 bg-gray-100 rounded"></div><div className="w-16 h-3 bg-gray-50 rounded"></div></div></td>                    <td className="py-10 text-center"><div className="mx-auto w-24 h-4 bg-gray-100 rounded"></div></td>                    <td className="py-10 pr-10 text-right"><div className="flex justify-end gap-4"><div className="w-20 h-8 bg-gray-100 rounded-xl"></div><div className="w-4 h-4 bg-gray-100 rounded"></div></div></td>                  </tr>                ))              ) : bills.length === 0 ? (                <tr>                  <td colSpan={5} className="py-20 text-center">                    <EmptyState title="No Invoices Recorded" subtitle="Fiscal registry is currently empty for this period." />                  </td>                </tr>              ) : (                bills.map((bill, idx) => (                  <tr key={bill.id} className="hover:bg-primary-50/30 transition-all group cursor-pointer" style={{ animationDelay: `${idx * 50}ms` }}>                    <td className="py-10 pl-10">                      <span className="font-mono text-[10px] font-black text-emerald-600 bg-white border-2 border-emerald-50 px-4 py-2 rounded-xl group-hover:border-emerald-200 transition-all uppercase tracking-widest shadow-sm">                        INV-{bill.id.toString().padStart(5, '0')}                      </span>                    </td>                    <td className="py-10">                      <div className="flex items-center gap-4">                        <div className="w-12 h-12 rounded-2xl bg-gray-100 border border-gray-100 shadow-sm flex items-center justify-center text-gray-500 font-black group-hover:scale-110 transition-transform">                          {bill.patient_name?.charAt(0) || 'P'}                        </div>                        <div>                          <p className="font-black text-gray-900 text-sm leading-tight">{bill.patient_name || 'Anonymous Patient'}</p>                          <p className="text-[11px] font-black text-gray-500 uppercase tracking-widest mt-1.5 leading-none">Verified Primary</p>                        </div>                      </div>                    </td>                    <td className="py-10 text-right">                      <div className="flex flex-col items-end">                        <p className="font-black text-gray-900 text-lg leading-none tracking-tight">Rs.{(parseFloat(bill.total_amount) || 0).toLocaleString()}</p>                        <p className="text-[9px] font-extrabold text-emerald-500 uppercase mt-1.5 tracking-widest">Tax Inclusive</p>                      </div>                    </td>                    <td className="py-10 text-center uppercase">                      <div className="flex items-center justify-center gap-2.5 text-gray-600 font-black text-[10px] tracking-widest">                        <FaCalendarAlt size={10} className="text-gray-300" />                        {new Date(bill.created_at).toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' })}                      </div>                    </td>                    <td className="py-10 pr-10 text-right">                      <div className="flex items-center justify-end gap-6">                        <span className={`px-5 py-2 rounded-xl text-[9px] font-black uppercase tracking-widest border-2 shadow-sm transition-all ${bill.status === 'paid'                          ? 'bg-emerald-50 text-emerald-600 border-emerald-100'                          : 'bg-rose-50 text-rose-600 border-rose-100'                          }`}>                          {bill.status}                        </span>                        <FaChevronRight size={12} className="text-gray-300 group-hover:text-primary-500 group-hover:translate-x-1 transition-all" />                      </div>                    </td>                  </tr>                ))              )}            </tbody>          </table>        </div>        <div className="p-8 bg-gray-50 border-t border-gray-100 flex justify-between items-center">          <p className="text-[11px] font-black text-gray-600 uppercase tracking-[0.2em] flex items-center gap-3">            <FaExclamationCircle className="text-amber-500" /> Revenue Records are legally binding and clinical-verified.          </p>          <SPALink href="billing" className="text-[11px] font-black text-primary-600 hover:text-primary-700 uppercase tracking-widest flex items-center gap-2">            View Full Ledger Detail <FaArrowRight size={10} />          </SPALink>        </div>      </div>    </div>  );}