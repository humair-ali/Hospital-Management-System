'use client';import { useUser, hasRole } from '@/context/UserContext';import { useState, useEffect } from 'react';import { getAppointments, updateAppointment } from '@/lib/api';import { toast } from 'react-toastify';import {  FaHeartbeat, FaNotesMedical, FaClipboardList,  FaUsers, FaTimes, FaClock, FaStethoscope, FaVials,  FaPills, FaSave, FaShieldAlt, FaCheckCircle} from 'react-icons/fa';import { PageHeader } from '@/components/ui/PageHeader';import { StatCard } from '@/components/ui/StatCard';import { LoadingState } from '@/components/ui/LoadingState';import { EmptyState } from '@/components/ui/EmptyState';export default function NurseDashboard() {  const { user, loading } = useUser();  const [appointments, setAppointments] = useState([]);  const [dataLoading, setDataLoading] = useState(true);  const [selectedApt, setSelectedApt] = useState(null);  const [vitalsNotes, setVitalsNotes] = useState('');  const [isModalOpen, setIsModalOpen] = useState(false);  useEffect(() => {    if (user && hasRole(user.role, ['nurse', 'admin'])) {      fetchData();    }  }, [user]);  async function fetchData() {    try {      const appts = await getAppointments({ status: 'confirmed' });      setAppointments(appts.data || []);    } catch (err) {      console.error('Clinical encounter sync failure:', err);    } finally {      setDataLoading(false);    }  }  function openVitalsModal(apt) {    setSelectedApt(apt);    setVitalsNotes(apt.notes || '');    setIsModalOpen(true);  }  async function handleSaveVitals() {    if (!selectedApt) return;    const updatedApt = { ...selectedApt, notes: vitalsNotes };    setAppointments(prev => prev.map(a => a.id === selectedApt.id ? updatedApt : a));    setIsModalOpen(false);    try {      await updateAppointment(selectedApt.id, { notes: vitalsNotes });      toast.success('Clinical Vitals Synchronized');    } catch (err) {      toast.error('Vitals Committal Failure');      fetchData();    }  }  const today = new Date();  const dateString = today.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });  const actions = (    <div className="flex items-center gap-4 bg-white px-6 py-2.5 rounded-2xl border border-gray-100 shadow-xl">      <div className="w-10 h-10 rounded-xl bg-blue-50 text-blue-600 flex items-center justify-center shadow-inner">        <FaShieldAlt size={16} />      </div>      <div>        <p className="text-[11px] font-black text-gray-500 uppercase tracking-[0.2em] mb-0.5">Clinical Shift</p>        <p className="text-sm font-black text-gray-700">{dateString}</p>      </div>    </div>  );  return (    <div className="h-full flex flex-col gap-10 animate-in fade-in duration-700">      <PageHeader        title={`Nurse Hub: ${user?.name}`}        subtitle="Real-time triage and patient monitoring dashboard"        actions={actions}      />      <div className="grid grid-cols-1 md:grid-cols-3 gap-8">        <StatCard          title="Triage Pending"          value={appointments.filter(a => !a.notes).length}          icon={FaHeartbeat}          variant="danger"          description="Critical priority index"          loading={dataLoading}        />        <StatCard          title="Queued Patients"          value={appointments.length}          icon={FaUsers}          variant="indigo"          description="Awaiting clinical triage"          loading={dataLoading}        />        <StatCard          title="Synchronized"          value={appointments.filter(a => a.notes).length}          icon={FaCheckCircle}          variant="emerald"          description="Vitals successfully logged"          loading={dataLoading}        />      </div>      <div className="bg-white rounded-[2.5rem] border border-gray-100 shadow-2xl shadow-gray-200/50 overflow-hidden flex flex-col flex-1">        <div className="p-10 border-b border-gray-50 flex items-center justify-between bg-gray-50/30">          <div>            <h3 className="text-2xl font-black text-gray-900 tracking-tight flex items-center gap-4">              Care Registry <span className="text-[10px] font-black text-primary-600 bg-primary-50 px-4 py-1.5 rounded-full border border-primary-100 uppercase tracking-widest">TRIAGE-VEC</span>            </h3>            <p className="text-[11px] font-black text-gray-500 mt-2 uppercase tracking-[0.2em] leading-relaxed">Awaiting clinical vital synchronization</p>          </div>          <div className="flex gap-3">            {[FaStethoscope, FaVials, FaPills].map((Icon, i) => (              <div key={i} className="w-12 h-12 rounded-2xl bg-white text-gray-300 flex items-center justify-center hover:text-primary-500 hover:shadow-lg transition-all cursor-pointer border border-gray-100">                <Icon size={18} />              </div>            ))}          </div>        </div>        <div className="flex-1 overflow-auto">          <table className="w-full border-collapse">            <thead>              <tr className="bg-gray-50/50">                <th className="py-8 pl-10 text-left text-[10px] font-black text-gray-400 uppercase tracking-[0.2em]">Patient Identity</th>                <th className="py-8 text-left text-[10px] font-black text-gray-400 uppercase tracking-[0.2em]">Practitioner</th>                <th className="py-8 text-left text-[10px] font-black text-gray-400 uppercase tracking-[0.2em]">Schedule</th>                <th className="py-8 text-center text-[10px] font-black text-gray-400 uppercase tracking-[0.2em]">Vitals Status</th>                <th className="py-8 pr-10 text-right text-[10px] font-black text-gray-400 uppercase tracking-[0.2em]">Actions</th>              </tr>            </thead>            <tbody className="divide-y divide-gray-50">              {dataLoading ? (                [1, 2, 3].map((_, i) => (                  <tr key={i} className="animate-pulse">                    <td className="py-10 pl-10"><div className="flex items-center gap-4"><div className="w-12 h-12 rounded-2xl bg-gray-100"></div><div className="space-y-2"><div className="w-32 h-4 bg-gray-100 rounded"></div><div className="w-24 h-2 bg-gray-50 rounded"></div></div></div></td>                    <td className="py-10"><div className="w-28 h-5 bg-gray-100 rounded"></div></td>                    <td className="py-10"><div className="w-20 h-10 bg-gray-100 rounded-2xl"></div></td>                    <td className="py-10 text-center"><div className="mx-auto w-24 h-6 bg-gray-100 rounded-xl"></div></td>                    <td className="py-10 pr-10 text-right"><div className="ml-auto w-32 h-12 bg-gray-100 rounded-xl"></div></td>                  </tr>                ))              ) : appointments.length === 0 ? (                <tr>                  <td colSpan={5} className="py-20 text-center">                    <EmptyState title="Registry Empty" subtitle="No clinical encounters synchronized for triage." />                  </td>                </tr>              ) : (                appointments.map((apt) => (                  <tr key={apt.id} className="hover:bg-primary-50/30 transition-all group">                    <td className="py-10 pl-10">                      <div className="flex items-center gap-4">                        <div className="w-12 h-12 rounded-2xl bg-gradient-to-br from-primary-100 to-primary-200 text-primary-600 flex items-center justify-center font-black text-lg shadow-sm group-hover:scale-110 transition-transform">                          {apt.patient_name?.charAt(0) || 'P'}                        </div>                        <div>                          <p className="font-black text-gray-900 leading-tight">{apt.patient_name}</p>                          <p className="text-[11px] font-black text-gray-500 uppercase tracking-widest mt-1.5 leading-none">Confirmed clinical encounter</p>                        </div>                      </div>                    </td>                    <td className="py-10">                      <p className="font-black text-gray-700 text-sm">Dr. {apt.doctor_name}</p>                    </td>                    <td className="py-10">                      <div className="flex items-center gap-2.5 bg-gray-100 w-fit px-5 py-2.5 rounded-2xl border border-gray-200 group-hover:bg-white transition-colors">                        <FaClock size={10} className="text-primary-500" />                        <span className="text-[11px] font-black text-gray-900 uppercase tracking-tighter">{new Date(apt.scheduled_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>                      </div>                    </td>                    <td className="py-10 text-center">                      <span className={`px-5 py-2 rounded-xl text-[9px] font-black uppercase tracking-widest border-2 shadow-sm ${apt.notes ? 'bg-emerald-50 text-emerald-600 border-emerald-100' : 'bg-rose-50 text-rose-600 border-rose-100'                        }`}>                        {apt.notes ? 'Synchronized' : 'Required'}                      </span>                    </td>                    <td className="py-10 pr-10 text-right">                      <button                        onClick={() => openVitalsModal(apt)}                        className="btn-primary h-12 px-8 text-[10px] uppercase tracking-[0.2em] shadow-xl shadow-primary-500/10 active:scale-95 transition-all"                      >                        Update Vitals                      </button>                    </td>                  </tr>                ))              )}            </tbody>          </table>        </div>      </div>      {isModalOpen && (        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-gray-950/80 backdrop-blur-md animate-in fade-in duration-300">          <div className="bg-white rounded-[3rem] shadow-2xl w-full max-w-xl overflow-hidden border border-white/20 animate-in zoom-in-95 duration-200">            <div className="px-12 py-10 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">              <div>                <h3 className="text-2xl font-black text-gray-900 tracking-tight leading-none uppercase">Clinical <span className="text-primary-600">Observation</span></h3>                <p className="text-[11px] font-black text-gray-500 uppercase tracking-[0.2em] mt-3">Telemetry Data Capture Vector</p>              </div>              <button                onClick={() => setIsModalOpen(false)}                className="w-12 h-12 flex items-center justify-center rounded-2xl hover:bg-white hover:shadow-lg text-gray-300 hover:text-gray-900 transition-all border border-transparent hover:border-gray-100"              >                <FaTimes size={18} />              </button>            </div>            <div className="p-12 space-y-10">              <div className="bg-primary-600 rounded-[2rem] p-8 text-white shadow-2xl shadow-primary-500/20 relative overflow-hidden group">                <div className="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-bl-full pointer-events-none group-hover:scale-110 transition-transform"></div>                <div className="relative">                  <p className="text-[11px] font-black uppercase tracking-[0.3em] text-primary-50 mb-3">Authenticated Principal</p>                  <p className="text-3xl font-black tracking-tight">{selectedApt?.patient_name}</p>                  <p className="text-[10px] font-black text-primary-200 mt-3 opacity-80">ENCOUNTER CODE: #ENC-{selectedApt?.id}</p>                </div>              </div>              <div className="space-y-4">                <div className="flex justify-between items-end px-1">                  <label className="text-[10px] font-black text-gray-900 uppercase tracking-[0.2em]">Observational Telemetry (Vitals)</label>                  <span className="text-[9px] font-black text-primary-600 bg-primary-50 px-3 py-1 rounded-full uppercase tracking-widest border border-primary-100">Standard Protocol</span>                </div>                <textarea                  value={vitalsNotes}                  onChange={(e) => setVitalsNotes(e.target.value)}                  className="w-full h-48 bg-gray-50 border-2 border-transparent focus:border-primary-100 focus:bg-white rounded-[2rem] p-8 text-base font-black text-gray-700 outline-none transition-all placeholder-gray-300 shadow-inner"                  placeholder="BP: 120/80 &#10;HR: 72 bpm &#10;Temp: 98.6Â°F &#10;SpO2: 98%"                />              </div>              <div className="flex gap-4">                <button onClick={() => setIsModalOpen(false)} className="flex-1 btn-secondary h-16 rounded-2xl font-black text-[10px] uppercase tracking-[0.2em] transition-all active:scale-95">                  Abort                </button>                <button onClick={handleSaveVitals} className="flex-[2] btn-primary h-16 rounded-2xl font-black text-[10px] uppercase tracking-[0.2em] transition-all shadow-2xl shadow-primary-500/20 flex items-center justify-center gap-3 active:scale-95 group">                  <FaSave size={16} /> Commit Vitals                </button>              </div>            </div>          </div>        </div>      )}    </div>  );}